# RAG 系统实现流程文档

## 1. 系统概述

RAG（Retrieval-Augmented Generation）系统结合了检索和生成能力，通过从知识库中检索相关信息来增强大语言模型的生成效果。本系统提供了一个完整的知识管理和问答解决方案。

## 2. 系统架构

### 2.1 主要组件

- **FastAPI Web服务**：提供RESTful API接口
- **知识库管理**：管理知识库和文档的CRUD操作
- **文档处理**：解析PDF/Word文档并提取内容
- **向量检索**：使用嵌入模型进行语义搜索
- **重排序**：对检索结果进行相关性重排序
- **大语言模型**：基于检索内容生成回答

### 2.2 技术栈

- FastAPI (Web框架)
- SentenceTransformers (嵌入模型)
- Transformers (重排序模型)
- Elasticsearch (向量存储和检索)
- OpenAI API (LLM生成)
- SQLAlchemy (数据库ORM)

## 3. 核心流程

### 3.1 知识库管理流程

#### 创建知识库

1. 客户端发送POST请求到 `/v1/knowledge_base`
2. 系统创建知识库记录并存储到数据库
3. 返回知识库ID和创建状态

#### 查询知识库

1. 客户端发送GET请求到 `/v1/knowledge_base`
2. 系统从数据库查询知识库信息
3. 返回知识库详情或404错误

#### 删除知识库

1. 客户端发送DELETE请求到 `/v1/knowledge_base`
2. 系统从数据库删除知识库记录
3. 返回删除状态

### 3.2 文档管理流程

#### 上传文档

1. 客户端发送POST请求到 `/v1/document` 包含文件和数据
2. 系统验证知识库存在性
3. 存储文件到本地文件系统
4. 创建文档数据库记录
5. 启动后台任务处理文档内容

#### 文档处理（后台任务）

1. 根据文件类型调用相应的解析器（PDF/Word）
2. 提取文档文本内容
3. 分块处理文本（带重叠）
4. 生成文本块的嵌入向量
5. 将文档元数据和内容块存储到Elasticsearch

#### PDF文档解析具体流程

1. 使用pdfplumber打开PDF文件
2. 逐页提取文本内容
3. 前3页内容作为摘要
4. 对每页完整内容生成嵌入向量并存储
5. 对每页内容进行分块处理
6. 对每个文本块生成嵌入向量并存储
7. 存储文档元数据到Elasticsearch

### 3.3 问答流程

#### 检索阶段

1. 接收用户查询
2. 执行两种检索方式：
   - **全文检索**：使用BM25算法进行关键词匹配
   - **向量检索**：使用嵌入模型进行语义相似度搜索
3. 使用RRF（Reciprocal Rank Fusion）算法融合两种检索结果
4. 可选：使用重排序模型对结果进行精排

#### 生成阶段

1. 构建提示模板，包含当前时间、检索到的相关文档和用户问题
2. 调用大语言模型生成回答
3. 返回生成的回答

### 3.4 嵌入和重排序流程

#### 文本嵌入

1. 使用预训练的SentenceTransformer模型
2. 支持模型：bge-small-zh-v1.5, bge-base-zh-v1.5
3. 生成归一化的文本向量

#### 重排序

1. 使用预训练的Transformer模型
2. 支持模型：bge-reranker-base
3. 对查询-文档对进行相关性打分

## 4. 数据存储

### 4.1 关系数据库（MySQL/PostgreSQL）

- `KnowledgeDatabase`：知识库元数据
- `KnowledgeDocument`：文档元数据

### 4.2 Elasticsearch

- `chunk_info`：存储文档分块内容及嵌入向量
- `document_meta`：存储文档元数据和摘要

## 5. API接口

### 5.1 知识库管理

- `GET /v1/knowledge_base`：查询知识库
- `POST /v1/knowledge_base`：创建知识库
- `DELETE /v1/knowledge_base`：删除知识库

### 5.2 文档管理

- `GET /v1/document`：查询文档
- `POST /v1/document`：上传文档
- `DELETE /v1/document`：删除文档

### 5.3 核心功能

- `POST /v1/embedding`：文本向量化
- `POST /v1/rerank`：文本对重排序
- `POST /chat`：问答接口

## 6. 配置管理

系统通过`config.yaml`文件进行配置，包括：

- 模型路径和参数
- RAG相关参数（分块大小、重叠大小等）
- 设备配置（CPU/GPU）
- API密钥和基础URL

## 7. 错误处理

系统实现了完整的错误处理机制：

- 数据库操作重试机制（最多10次）
- 异常捕获和日志记录
- 统一的响应格式包含状态码和错误信息

## 8. 性能优化

1. **模型加载**：启动时预加载嵌入和重排序模型
2. **批量处理**：支持批量文本的嵌入计算
3. **后台任务**：文档解析使用后台任务避免阻塞主线程
4. **检索融合**：结合关键词和语义检索提高召回率

## 9. 扩展性

系统设计考虑了扩展性：

- 支持多种嵌入和重排序模型
- 可扩展支持更多文件类型
- 模块化设计便于功能扩展

这个RAG系统提供了一个完整的企业级知识管理和智能问答解决方案，结合了传统检索和现代深度学习技术的优势。